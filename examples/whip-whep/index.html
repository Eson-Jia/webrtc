<html>

  <!--
		SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
		SPDX-License-Identifier: MIT
	-->
  <head>
    <title>whip-whep</title>
  </head>

  <body>
    <button onclick="window.doWHIP()">Publish</button>
    <button onclick="window.doWHEP()">Subscribe</button>
    <input type="text" id="publishId" placeholder="Enter Publish ID" />
    <input type="text" id="subscribeId" placeholder="Enter Subscribe ID" />
    <button onclick="window.WHIPAndWHEP()" >Publish and Subscribe</button>
    <h3> 推流 </h3>
    <video id="videoPlayer" autoplay muted controls style="width: 500"> </video>
    <h3> 拉流 </h3>

    <video id="videoPlayer1" autoplay muted controls style="width: 500"> </video>

    <h3> ICE Connection States </h3>
    <div id="iceConnectionStates"></div> <br />
  </body>

  <script>
    window.WHIPAndWHEP = async () => {
      await window.doWHIP();
      await window.doWHEP();
    };

    window.doWHEP = async () => {
      let peerConnection = new RTCPeerConnection()
      peerConnection.oniceconnectionstatechange = () => {
        let el = document.createElement('p')
        el.appendChild(document.createTextNode(`WHEP: ${peerConnection.iceConnectionState}`))
        document.getElementById('iceConnectionStates').appendChild(el);
      }
      peerConnection.addTransceiver('audio', { direction: 'recvonly' })

      peerConnection.ontrack = function (event) {
        document.getElementById('videoPlayer1').srcObject = event.streams[0]
      }

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer)
        let target = '/whep';
        if (document.getElementById('subscribeId').value) {
            target = `/whep/${document.getElementById('subscribeId').value}`
        }
        fetch(target, {
          method: 'POST',
          body: offer.sdp,
          headers: {
            Authorization: `Bearer none`,
            'Content-Type': 'application/sdp'
          }
        }).then(r => r.text())
          .then(answer => {
            peerConnection.setRemoteDescription({
              sdp: answer,
              type: 'answer'
            })
          })
      })
    }

    window.doWHIP = () => {
      let peerConnection = new RTCPeerConnection()
      peerConnection.oniceconnectionstatechange = () => {
        let el = document.createElement('p')
        el.appendChild(document.createTextNode(`WHIP: ${peerConnection.iceConnectionState}`))
        document.getElementById('iceConnectionStates').appendChild(el);
      }
      navigator.mediaDevices.getUserMedia({ video: false, audio: true })
        .then(stream => {
          document.getElementById('videoPlayer').srcObject = stream
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream))

          peerConnection.createOffer().then(offer => {
            peerConnection.setLocalDescription(offer)
            let target = '/whip';
            if (document.getElementById('publishId').value) {
                target = `/whip/${document.getElementById('publishId').value}`
            }
            fetch(target, {
              method: 'POST',
              body: offer.sdp,
              headers: {
                Authorization: `Bearer none`,
                'Content-Type': 'application/sdp'
              }
            }).then(r => r.text())
              .then(answer => {
                peerConnection.setRemoteDescription({
                  sdp: answer,
                  type: 'answer'
                })
              })
          })
      })
    }
  </script>
</html>
